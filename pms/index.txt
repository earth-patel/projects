import React, { useState } from 'react';
import { Link } from 'react-router';

import { loginUser } from '../api/auth';

type LoginPayload = {
  email: string;
  password: string;
};

type LoginErrors = Partial<LoginPayload> & { form?: string };

const Login = () => {
  const [errors, setErrors] = useState<LoginErrors>({});
  const [loading, setLoading] = useState(false);

  const validate = (data: Record<string, string>) => {
    const errs: LoginErrors = {};

    if (!data.email) errs.email = 'Email is required';
    if (!data.password) errs.password = 'Password is required';
    else if (data.password.length < 8)
      errs.password = 'Password must be at least 8 characters long';

    return errs;
  };

  const onLogin = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setLoading(true);
    setErrors({});

    const formData = new FormData(e.currentTarget);
    const data: LoginPayload = {
      email: formData.get('email') as string,
      password: formData.get('password') as string
    };

    const validationErrors = validate(data);

    if (Object.keys(validationErrors).length) {
      setErrors(validationErrors);
      setLoading(false);
      return;
    }

    try {
      const res = await loginUser(data);

      if (res?.errors) {
        setErrors(res.errors);
        return;
      }

      if (!res?.token) {
        setErrors({ form: 'Invalid response from server' });
        return;
      }
    } catch (error) {
      console.error('Error logging in user:', error);
      setErrors({ form: 'Something went wrong. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={onLogin}>
      <h2>Login</h2>

      <input type="email" name="email" placeholder="Email" required />
      {errors.email && <div style={{ color: 'red' }}>{errors.email}</div>}
      {!errors.email && <br />}
      <br />

      <input type="password" name="password" placeholder="Password" required />
      {errors.password && <div style={{ color: 'red' }}>{errors.password}</div>}
      {!errors.password && <br />}
      <br />

      <button type="submit" disabled={loading}>
        Login
      </button>
      {errors.form && <div style={{ color: 'red' }}>{errors.form}</div>}

      <p>
        Don't have an account?{' '}
        <button>
          <Link to="/register">Register</Link>
        </button>
      </p>
    </form>
  );
};

export default Login;
